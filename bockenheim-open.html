<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Bockenheim Open 2025</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet" />

  <style>
    :root{
      --primary-color:#0d6b33; --secondary-color:#f5f5f5; --accent-color:#d4af37;
      --text-color:#333; --card-bg:#fff; --danger-color:#c62828;
      --highlight:#fffbef; --highlight-border:#d4af37;
    }
    body{font-family:'Montserrat',sans-serif;margin:0;background:var(--secondary-color);color:var(--text-color);line-height:1.6}
    @keyframes fadeInDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
    .header{background:var(--primary-color);
      background-image:
        linear-gradient(135deg,rgba(255,255,255,.05) 25%,transparent 25%),
        linear-gradient(225deg,rgba(255,255,255,.05) 25%,transparent 25%),
        linear-gradient(45deg,rgba(255,255,255,.05) 25%,transparent 25%),
        linear-gradient(315deg,rgba(255,255,255,.05) 25%,var(--primary-color) 25%);
      background-position:10px 0,10px 0,0 0,0 0;background-size:20px 20px;background-repeat:repeat;
      color:#fff;text-align:center;padding:3rem 1rem 4rem;clip-path:polygon(0 0,100% 0,100% 85%,50% 100%,0 85%);margin-bottom:-3rem;position:relative;z-index:10}
    .header h1{margin:0;font-size:clamp(2.5rem,8vw,4rem);font-weight:900;text-transform:uppercase;letter-spacing:4px;text-shadow:3px 3px 10px rgba(0,0,0,.5);animation:fadeInDown 1s ease-out}
    .header p{margin:.5rem 0 0;font-size:clamp(1rem,4vw,1.2rem);opacity:.9;font-weight:700}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .card{background:var(--card-bg);border-radius:15px;padding:25px;margin-bottom:25px;box-shadow:0 10px 20px rgba(0,0,0,.08);border-left:5px solid var(--primary-color)}
    h2{font-size:2rem;font-weight:700;color:var(--primary-color);border-bottom:3px solid var(--accent-color);padding-bottom:10px;margin-top:0}
    #map{height:500px;width:100%;border-radius:10px}

    .stop{padding:15px;margin-bottom:20px;border-radius:10px;background:#fafafa;border:1px solid #eee}
    .stop-info{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px}
    .stop h3{margin:0;font-size:1.2rem}
    .drink{font-style:italic;color:#555}
    .par{font-weight:900;font-size:2.5rem;color:var(--primary-color);line-height:1}
    .par span{font-size:1rem;font-weight:400;display:block;color:#777}
    .stop.active{background:var(--highlight);border-left:5px solid var(--highlight-border);transform:scale(1.02);transition:all .25s ease}

    #current-challenge-card{display:none;text-align:center;border-color:var(--highlight-border);background:var(--highlight)}
    #current-challenge-card h2{font-size:1.5rem}
    #current-challenge-card .par{font-size:3rem;margin-top:1rem}

    ul.rules-list{list-style:none;padding:0}
    ul.rules-list li{padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    ul.rules-list li:last-child{border-bottom:none}
    .penalty{font-weight:700;font-size:1.2rem}
    .penalty.positive{color:#c62828} .penalty.negative{color:#2e7d32}

    table{width:100%;border-collapse:collapse;margin-top:20px;font-size:.9rem}
    th,td{border:1px solid #ddd;padding:10px;text-align:center}
    th{background:var(--primary-color);color:#fff;font-weight:700}
    td.team-name{font-weight:bold;text-align:left}
    td.total{font-weight:900;background:#e8f5e9;font-size:1.1rem}

    .countdown,.timer{text-align:center}
    .countdown-container{display:flex;justify-content:center;gap:20px;margin-top:15px}
    .countdown-item{background:var(--secondary-color);padding:10px;border-radius:10px;min-width:80px}
    .countdown-number{font-size:2.5rem;font-weight:700;color:var(--primary-color)}
    .countdown-label{font-size:.9rem;color:#777}
    .timer-display{font-size:4rem;font-weight:900;color:var(--primary-color);margin:10px 0}
    .timer-controls button{background:var(--primary-color);color:#fff;border:none;padding:12px 25px;font-size:1rem;border-radius:8px;cursor:pointer;margin:5px;transition:background-color .3s,transform .2s}
    .timer-controls button:hover{background:#0a5227;transform:translateY(-2px)}
    .timer-controls button:disabled{background:#999;cursor:not-allowed}

    .admin-panel{background:var(--text-color);color:#fff;border-radius:15px;padding:25px;margin-top:30px}
    .admin-panel h2,.admin-panel h3{color:#fff;border-color:var(--accent-color)}
    .admin-panel input,.admin-panel select,.admin-panel button{width:100%;padding:12px;margin-bottom:10px;border-radius:5px;border:none;box-sizing:border-box}
    .admin-panel button{background:var(--accent-color);color:var(--text-color);font-weight:bold;cursor:pointer;transition:transform .2s ease}
    .admin-panel button:hover{transform:scale(1.02)}
    #admin-content{display:none}
    .danger-button{background:var(--danger-color)!important;color:#fff}
    .confirm-button{background:#ff3d00!important;color:#fff}
  </style>
</head>
<body>
<header class="header">
  <h1>Bockenheim Open</h1>
  <p>Hostet by BAC / Basalt WG</p>
</header>

<main class="container">
  <section class="card countdown">
    <h2>Tour Start</h2>
    <div id="countdown-container" class="countdown-container">
      <div class="countdown-item"><span id="days" class="countdown-number">0</span><span class="countdown-label">Tage</span></div>
      <div class="countdown-item"><span id="hours" class="countdown-number">0</span><span class="countdown-label">Stunden</span></div>
      <div class="countdown-item"><span id="minutes" class="countdown-number">0</span><span class="countdown-label">Minuten</span></div>
      <div class="countdown-item"><span id="seconds" class="countdown-number">0</span><span class="countdown-label">Sekunden</span></div>
    </div>
    <p id="countdown-message" style="font-weight:bold;margin-top:15px;"></p>
  </section>

  <section class="card" id="current-challenge-card">
    <h2>AKTUELLE CHALLENGE</h2>
    <div id="current-challenge-content">
      <p>Der Admin hat die Tour noch nicht gestartet.</p>
    </div>
  </section>

  <section class="card">
    <h2>Die Route & Karte</h2>
    <div id="map"></div>
  </section>

  <section class="card">
    <h2>Die 9 Löcher (Tour-Plan)</h2>
    <div id="stops-list"></div>
  </section>

  <section class="card">
    <h2>Live Leaderboard</h2>
    <div style="overflow-x:auto">
      <table id="leaderboard">
        <thead>
          <tr>
            <th>Team</th>
            <th>Strafen</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h2>Regelwerk</h2>
    <ul class="rules-list">
      <li>Getränk verschüttet <span class="penalty positive">+2</span></li>
      <li>Hole-in-One (auf ex getrunken) <span class="penalty negative">-1</span></li>
      <li>Loch nicht beendet <span class="penalty positive">+3</span></li>
      <li>Nicht mit dem Partner getrunken (1x Joker) <span class="penalty positive">+3</span></li>
      <li>Party-Hut abgenommen <span class="penalty positive">+1</span></li>
    </ul>
  </section>

  <section class="card timer">
    <h2>10-Sekunden Ex-Counter</h2>
    <div id="timer-display" class="timer-display">10.0</div>
    <div class="timer-controls">
      <button id="timer-start">Start</button>
      <button id="timer-reset">Reset</button>
    </div>
  </section>

  <section class="admin-panel">
    <h2>Admin-Steuerung</h2>

    <div id="login-section">
      <p>Passwort eingeben, um Scores zu verwalten.</p>
      <input type="password" id="admin-password" placeholder="Admin-Passwort" />
      <button onclick="unlockAdmin()">Freischalten</button>
    </div>

    <div id="admin-content">
      <h3>Scores pro Loch</h3>
      <label for="score-team-select">Team auswählen:</label>
      <select id="score-team-select"></select>

      <label for="hole-select">Loch auswählen:</label>
      <select id="hole-select"></select>

      <label for="score-input">Benötigte Schlücke:</label>
      <input type="number" id="score-input" placeholder="Anzahl" min="0" />
      <button onclick="updateScore()">Score eintragen</button>

      <hr style="margin:20px 0;border-color:#555">

      <h3>Strafen & Boni</h3>
      <label for="penalty-team-select">Team auswählen:</label>
      <select id="penalty-team-select"></select>
      <label for="penalty-select">Regel auswählen:</label>
      <select id="penalty-select"></select>
      <button onclick="applyPenalty()">Strafe/Bonus anwenden</button>

      <hr style="margin:20px 0;border-color:#555">

      <h3>Tour-Steuerung</h3>
      <label for="current-stop-select">Aktuellen Stopp festlegen:</label>
      <select id="current-stop-select"></select>
      <button onclick="setCurrentStop()">Als aktuellen Stopp setzen</button>

      <hr style="margin:20px 0;border-color:#555">

      <h3>Gefahrenzone</h3>
      <button id="reset-button" class="danger-button" onclick="requestFullReset()">ALLES ZURÜCKSETZEN</button>
      <button id="cancel-reset-button" style="display:none;background:#555;color:#fff" onclick="cancelReset()">Abbrechen</button>
    </div>
  </section>
</main>

<!-- ===== Original-Seitenlogik (ohne Storage) ===== -->
<script>
  const tourConfig = {
    stops: [
      { name:"Start: Basaltstraße 39", lat:50.1259278, lon:8.6441328, drink:"Long-Drink", par:4, address:"Basaltstraße 39" },
      { name:"Dalli Dalli Pilsstübchen", lat:50.1256647, lon:8.6436847, drink:"Bier/Appler", par:3, address:"Grempstraße 4" },
      { name:"Lüsterweibchen", lat:50.1241143, lon:8.6414999, drink:"Wein", par:3, address:"Große Seestraße 49a" },
      { name:"Kiosk am Platz", lat:50.1244439, lon:8.6434939, drink:"Shot", par:1, address:"Kurfürstenpl. 36" },
      { name:"Casa Blanca", lat:50.1198891, lon:8.6450849, drink:"Cocktail / Longdrink", par:4, address:"Adalbertstraße 34" },
      { name:"Zum Tannenbaum", lat:50.1189258, lon:8.6463081, drink:"Appler", par:3, address:"Adalbertstraße 53" },
      { name:"Khan Kiosk", lat:50.1198055, lon:8.6487065, drink:"Bier/Appler", par:3, address:"Leipziger Str. 2" },
      { name:"Extrablatt", lat:50.1198957, lon:8.6504733, drink:"Shot", par:1, address:"Bockenheimer Warte" },
      { name:"Doctor Flotte", lat:50.1204769, lon:8.65017, drink:"Bier / Appler / Wein", par:3, address:"Leipziger Str. 20" }
    ],
    teams:["Team Alpha","Team Bravo","Team Charlie","Team Delta","Team Echo","Team Foxtrot"],
    adminPassword:"bockenheim",
    rules:[
      { text:"Getränk verschüttet", value:2 },
      { text:"Hole-in-One (Exen)", value:-1 },
      { text:"Loch nicht beendet", value:3 },
      { text:"Partner-Regel missachtet", value:3 },
      { text:"Party-Hut abgenommen", value:1 }
    ]
  };

  // UI State (von Firestore kommend)
  window.scores = {};           // { [team]: { holes:number[], penalty:number } }
  window.currentStopIndex = -1; // nur Anzeige

  document.addEventListener('DOMContentLoaded', () => {
    initCountdown(); initExCounter(); initMap(); initStopsList(); initLeaderboard(); initAdminPanel();
  });

  // ---- Karte / Route
  let mapMarkers = [];
  function initMap(){
    const map = L.map('map').setView([50.123, 8.646], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
    const route = tourConfig.stops.map(s=>[s.lat,s.lon]);
    tourConfig.stops.forEach((stop,i)=>{
      const hole=i+1;
      const icon = L.divIcon({ html:`<div style="background-color: var(--primary-color); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;">${hole}</div>`, className:"", iconSize:[30,30], iconAnchor:[15,15] });
      const m = L.marker([stop.lat, stop.lon], { icon }).addTo(map)
        .bindPopup(`<b>Loch ${hole}: ${stop.name}</b><br>${stop.address}<br><i>Getränk: ${stop.drink}</i><br><b>Par: ${stop.par}</b>`);
      mapMarkers.push(m);
    });
    L.polyline(route,{ color:'var(--primary-color)', weight:4, opacity:.8 }).addTo(map);
  }

  // ---- Stops-Liste
  function initStopsList(){
    const el=document.getElementById('stops-list'); el.innerHTML='';
    tourConfig.stops.forEach((stop,i)=>{
      const hole=i+1;
      const div=document.createElement('div'); div.className='stop'; div.id=`stop-list-item-${i}`;
      div.innerHTML=`<div class="stop-info"><div><h3>${hole}. ${stop.name}</h3><p class="drink">Getränk: ${stop.drink}</p></div><div class="par">${stop.par}<span>PAR</span></div></div>`;
      el.appendChild(div);
    });
  }

  // ---- Leaderboard (Header + Render)
  function initLeaderboard(){
    const thead=document.querySelector('#leaderboard thead tr');
    thead.innerHTML='<th>Rang</th><th>Team</th>';
    for(let i=1;i<=tourConfig.stops.length;i++){ const th=document.createElement('th'); th.textContent=String(i); thead.appendChild(th); }
    thead.innerHTML += '<th>Strafen</th><th>Total</th>';
  }
  function updateLeaderboardView(){
    const tbody=document.querySelector('#leaderboard tbody'); tbody.innerHTML='';
    // Baue Reihenfolge nach TEAMS; falls Score fehlt, mit 0en anzeigen
    const rows = tourConfig.teams.map(name=>{
      const t = window.scores[name] || { holes:Array(tourConfig.stops.length).fill(0), penalty:0 };
      const total = (t.holes||[]).reduce((a,b)=>a+(b||0),0) + (t.penalty||0);
      return { name, holes:t.holes, penalty:t.penalty, total };
    }).sort((a,b)=>a.total-b.total);

    rows.forEach((t,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td><b>${idx+1}.</b></td><td class="team-name">${t.name}</td>${t.holes.map(v=>`<td>${v>0?v:'-'}</td>`).join('')}<td>${t.penalty||0}</td><td class="total">${t.total}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ---- Aktuelle Challenge (nur Anzeige/Highlight)
  function updateCurrentStopView(scrollIntoView){
    const card=document.getElementById('current-challenge-card');
    const content=document.getElementById('current-challenge-content');
    const i=window.currentStopIndex;
    if (i < 0 || i >= tourConfig.stops.length){ card.style.display='none'; document.querySelectorAll('.stop').forEach(el=>el.classList.remove('active')); return; }
    const stop=tourConfig.stops[i]; const n=i+1;
    content.innerHTML = `<h3>Loch ${n}: ${stop.name}</h3><p><strong>Getränk:</strong> ${stop.drink}</p><div class="par">${stop.par}<span>PAR</span></div>`;
    card.style.display='block';

    document.querySelectorAll('.stop').forEach(el=>el.classList.remove('active'));
    const active=document.getElementById(`stop-list-item-${i}`); if(active){ active.classList.add('active'); if(scrollIntoView) active.scrollIntoView({behavior:'smooth',block:'center'}); }

    // Marker highlighten
    mapMarkers.forEach((m,idx)=>{
      const size = idx===i ? 40 : 30, anchor = idx===i ? 20 : 15;
      const html = `<div style="background-color:${idx===i?'var(--accent-color)':'var(--primary-color)'};color:${idx===i?'black':'white'};border-radius:50%;width:${size}px;height:${size}px;display:flex;align-items:center;justify-content:center;font-weight:bold;border:${idx===i?3:2}px solid white;">${idx+1}</div>`;
      m.setIcon(L.divIcon({ html, className:'', iconSize:[size,size], iconAnchor:[anchor,anchor] }));
    });
  }

  // ---- Countdown & Timer
  function initCountdown(){
    const now=new Date(); const saturday=new Date(now);
    saturday.setDate(now.getDate()+((6-now.getDay()+7)%7)); saturday.setHours(21,0,0,0);
    const target=saturday.getTime();
    const iv=setInterval(()=>{
      const d=target-Date.now(); if(d<0){ clearInterval(iv); document.getElementById('countdown-container').style.display='none'; document.getElementById('countdown-message').textContent='Die Bockenheim Open haben begonnen! Viel Erfolg!'; return; }
      const dd=Math.floor(d/(1000*60*60*24));
      const hh=Math.floor((d%(1000*60*60*24))/(1000*60*60));
      const mm=Math.floor((d%(1000*60*60))/(1000*60));
      const ss=Math.floor((d%(1000*60))/1000);
      document.getElementById('days').textContent=dd;
      document.getElementById('hours').textContent=hh;
      document.getElementById('minutes').textContent=mm;
      document.getElementById('seconds').textContent=ss;
    },1000);
  }
  let exTimerInterval;
  function initExCounter(){
    const start=document.getElementById('timer-start');
    const reset=document.getElementById('timer-reset');
    const disp=document.getElementById('timer-display');
    start.addEventListener('click', ()=>{
      start.disabled=true; const end=Date.now()+10000;
      exTimerInterval=setInterval(()=>{
        const left=end-Date.now();
        if (left<=0){ clearInterval(exTimerInterval); disp.textContent='0.0'; start.disabled=false; return; }
        disp.textContent=(left/1000).toFixed(1);
      },100);
    });
    reset.addEventListener('click', ()=>{ clearInterval(exTimerInterval); disp.textContent='10.0'; start.disabled=false; });
  }

  // ---- Admin-UI
  function initAdminPanel(){
    const tSel=document.getElementById('score-team-select');
    const pSel=document.getElementById('penalty-team-select');
    const hSel=document.getElementById('hole-select');
    const cSel=document.getElementById('current-stop-select');
    const rSel=document.getElementById('penalty-select');

    [tSel,pSel,hSel,cSel,rSel].forEach(el=>el.innerHTML='');

    tourConfig.teams.forEach(t=>{ tSel.appendChild(new Option(t,t)); pSel.appendChild(new Option(t,t)); });
    tourConfig.stops.forEach((s,i)=>{ const o=new Option(`Loch ${i+1}: ${s.name}`, i); hSel.appendChild(o.cloneNode(true)); cSel.appendChild(o); });
    tourConfig.rules.forEach(r=> rSel.appendChild(new Option(`${r.text} (${r.value>0?'+':''}${r.value})`, r.value)));
  }

  window.unlockAdmin = function(){
    const pw=document.getElementById('admin-password').value;
    if (pw===tourConfig.adminPassword){ document.getElementById('login-section').style.display='none'; document.getElementById('admin-content').style.display='block'; }
    else alert('Falsches Passwort!');
  };
</script>

<!-- ===== Firebase + Firestore (Realtime) ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // --- deine Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyDX5k40Sh4PPIAB0AlaUOAO5w_J9kkTetU",
    authDomain: "bockenheimopen.firebaseapp.com",
    projectId: "bockenheimopen",
    storageBucket: "bockenheimopen.firebasestorage.app",
    messagingSenderId: "1041085407769",
    appId: "1:1041085407769:web:4e69958e8adf684b10c088",
    measurementId: "G-ZBHWE97Z0G"
  };

  // --- Init ---
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);

  // --- App-IDs ---
  const EVENT_ID = "bockenheim-open-2025";
  const HOLES = window.tourConfig?.stops?.length ?? 9;
  const TEAMS = (window.tourConfig?.teams ?? []).slice();

  // --- Firestore Refs ---
  const teamsCol = collection(db, "events", EVENT_ID, "teams");
  const eventDoc = doc(db, "events", EVENT_ID); // aktueller Stop liegt hier

  // --- Helpers ---
  const holesArray = (n=HOLES)=>Array(n).fill(0);
  const log=(...a)=>console.log("[BO-Firestore]",...a);
  const err=(...a)=>console.error("[BO-Firestore]",...a);

  // --- Login & Start ---
  signInAnonymously(auth).catch(err);
  onAuthStateChanged(auth, async (user)=>{
    if(!user) return;
    log("angemeldet (anonymous):", user.uid);
    await ensureEventDoc();
    await seedMissingTeams(); // ergänzt fehlende Teams IMMER
    attachRealtime();
  });

  // sorgt dafür, dass das Event-Dokument existiert
  async function ensureEventDoc(){
    await setDoc(eventDoc, { currentStopIndex: -1 }, { merge:true });
  }

  // ergänzt alle fehlenden Teams; passt holes-Länge an HOLES an
  async function seedMissingTeams(){
    const snap = await getDocs(teamsCol);
    const existing = new Set();
    snap.forEach(d=>existing.add(d.id));
    const ops = [];

    TEAMS.forEach(name=>{
      if(!existing.has(name)){
        ops.push(setDoc(doc(db,"events",EVENT_ID,"teams",name), { name, holes:holesArray(), penalty:0 }, { merge:true }));
      }
    });

    // padding für bereits existierende Teams
    snap.forEach(d=>{
      const data=d.data()||{};
      const arr=Array.isArray(data.holes)? data.holes.slice(0,HOLES).concat(holesArray(HOLES-(data.holes?.length||0))) : holesArray();
      ops.push(setDoc(d.ref, { holes:arr, penalty:Number.isFinite(data.penalty)?data.penalty:0, name:data.name||d.id }, { merge:true }));
    });

    if (ops.length) await Promise.all(ops);
  }

  // --- Realtime Attach ---
  function attachRealtime(){
    // TEAMS (Scores)
    onSnapshot(teamsCol, (snap)=>{
      log("Teams snapshot:", snap.size, "docs");
      const next = {};
      // standardmäßig alle Teams 0en; werden gleich überschrieben
      TEAMS.forEach(t=> next[t]={ holes:holesArray(), penalty:0 });

      snap.forEach(d=>{
        const data=d.data()||{};
        const name=data.name || d.id;
        const holes = Array.isArray(data.holes)
          ? data.holes.slice(0,HOLES).concat(holesArray(HOLES-(data.holes?.length||0)))
          : holesArray();
        const penalty = Number.isFinite(data.penalty) ? data.penalty : 0;
        next[name] = { holes, penalty };
      });

      window.scores = next;
      if (typeof window.updateLeaderboardView === "function") window.updateLeaderboardView();
    }, err);

    // aktueller Stop (nur Anzeige)
    onSnapshot(eventDoc, (docSnap)=>{
      const st=docSnap.data()||{ currentStopIndex:-1 };
      window.currentStopIndex = Number.isFinite(st.currentStopIndex) ? st.currentStopIndex : -1;
      log("State snapshot: currentStopIndex =", window.currentStopIndex);
      if (typeof window.updateCurrentStopView === "function") window.updateCurrentStopView(false);
      const sel=document.getElementById('current-stop-select'); if (sel) sel.value=String(window.currentStopIndex);
    }, err);

    // --- Schreibfunktionen überschreiben (Admin-Buttons) ---
    window.updateScore = async function(){
      const team = document.getElementById("score-team-select").value;
      const hole = parseInt(document.getElementById("hole-select").value,10);
      const val  = parseInt(document.getElementById("score-input").value,10);
      if(!team || isNaN(hole) || hole<0 || hole>=HOLES || isNaN(val) || val<0){ alert("Bitte gültige Zahl eingeben."); return; }

      const ref = doc(db,"events",EVENT_ID,"teams",team);
      const snap = await getDoc(ref);
      const base = snap.exists()? snap.data() : { name:team, holes:holesArray(), penalty:0 };
      const holes = Array.isArray(base.holes)? base.holes : holesArray();
      holes[hole] = val;
      await setDoc(ref, { name:team, holes, penalty:base.penalty||0 }, { merge:true });
      document.getElementById("score-input").value = "";
      log("Score gesetzt:", team, "Loch", hole+1, "=", val);
    };

    window.applyPenalty = async function(){
      const team  = document.getElementById('penalty-team-select').value;
      const delta = parseInt(document.getElementById('penalty-select').value,10);
      if(!team || isNaN(delta)) return;
      const ref = doc(db,"events",EVENT_ID,"teams",team);
      const snap = await getDoc(ref);
      const base = snap.exists()? snap.data() : { name:team, holes:holesArray(), penalty:0 };
      await setDoc(ref, { name:team, holes:base.holes||holesArray(), penalty:(base.penalty||0)+delta }, { merge:true });
      log("Penalty applied:", team, delta);
    };

    window.setCurrentStop = async function(){
      const idx = parseInt(document.getElementById('current-stop-select').value,10);
      if (isNaN(idx)) return;
      await setDoc(eventDoc, { currentStopIndex: idx }, { merge:true });
      log("Current stop gesetzt:", idx, "(nur Anzeige)");
    };

    window.requestFullReset = function(){
      const reset=document.getElementById('reset-button'), cancel=document.getElementById('cancel-reset-button');
      reset.textContent='SICHER? NOCHMAL KLICKEN ZUM LÖSCHEN!'; reset.classList.remove('danger-button'); reset.classList.add('confirm-button');
      reset.setAttribute('onclick','executeFullReset()'); cancel.style.display='block';
    };
    window.cancelReset = function(){
      const reset=document.getElementById('reset-button'), cancel=document.getElementById('cancel-reset-button');
      reset.textContent='ALLES ZURÜCKSETZEN'; reset.classList.remove('confirm-button'); reset.classList.add('danger-button');
      reset.setAttribute('onclick','requestFullReset()'); cancel.style.display='none';
    };
    window.executeFullReset = async function(){
      if (!confirm("Wirklich ALLES zurücksetzen?")) return;
      const snap = await getDocs(teamsCol);
      const deletions=[]; snap.forEach(d=>deletions.push(deleteDoc(d.ref)));
      await Promise.all(deletions);
      await setDoc(eventDoc, { currentStopIndex:-1 }, { merge:true });
      await seedMissingTeams();
      alert("Zurückgesetzt.");
      window.cancelReset?.();
      log("Reset done.");
    };
  }
</script>
</body>
</html>
