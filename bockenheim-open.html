<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bockenheim Open 2025 — Firebase</title>
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap"
    rel="stylesheet"
  />

  <style>
    :root{--primary-color:#0d6b33;--secondary-color:#f5f5f5;--accent-color:#d4af37;--text-color:#333;--card-bg:#fff;--danger-color:#c62828}
    body{font-family:'Montserrat',sans-serif;margin:0;background:var(--secondary-color);color:var(--text-color);line-height:1.6}
    @keyframes fadeInDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
    .header{background-color:var(--primary-color);background-image:linear-gradient(135deg,rgba(255,255,255,.05) 25%,transparent 25%),linear-gradient(225deg,rgba(255,255,255,.05) 25%,transparent 25%),linear-gradient(45deg,rgba(255,255,255,.05) 25%,transparent 25%),linear-gradient(315deg,rgba(255,255,255,.05) 25%,var(--primary-color) 25%);background-position:10px 0,10px 0,0 0,0 0;background-size:20px 20px;background-repeat:repeat;color:#fff;text-align:center;padding:3rem 1rem 4rem;clip-path:polygon(0 0,100% 0,100% 85%,50% 100%,0 85%);margin-bottom:-3rem;position:relative;z-index:10}
    .header h1{margin:0;font-size:clamp(2.5rem,8vw,4rem);font-weight:900;text-transform:uppercase;letter-spacing:4px;text-shadow:3px 3px 10px rgba(0,0,0,.5);animation:fadeInDown 1s ease-out}
    .header p{margin:.5rem 0 0;font-size:clamp(1rem,4vw,1.2rem);opacity:.9;font-weight:700}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .card{background:var(--card-bg);border-radius:15px;padding:25px;margin-bottom:25px;box-shadow:0 10px 20px rgba(0,0,0,.08);border-left:5px solid var(--primary-color)}
    h2{font-size:2rem;font-weight:700;color:var(--primary-color);border-bottom:3px solid var(--accent-color);padding-bottom:10px;margin-top:0}
    #map{height:500px;width:100%;border-radius:10px}
    .stop{padding:15px;margin-bottom:20px;border-radius:10px;background:#fafafa;border:1px solid #eee}
    .stop-info{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px}
    .stop h3{margin:0;font-size:1.2rem}
    .drink{font-style:italic;color:#555}
    .par{font-weight:900;font-size:2.5rem;color:var(--primary-color);line-height:1}
    .par span{font-size:1rem;font-weight:400;display:block;color:#777}
    #current-challenge-card{display:none;text-align:center;border-color:var(--accent-color);background:#fffbef}
    #current-challenge-card h2{font-size:1.5rem}
    #current-challenge-card p{font-size:1.2rem;margin:.5rem 0}
    #current-challenge-card .par{font-size:3rem;margin-top:1rem}
    .stop.active{background:#fffbef;border-left:5px solid var(--accent-color);transform:scale(1.02);transition:all .3s ease}
    ul.rules-list{list-style:none;padding:0}
    ul.rules-list li{padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    ul.rules-list li:last-child{border-bottom:none}
    ul.rules-list .penalty{font-weight:700;font-size:1.2rem}
    ul.rules-list .penalty.positive{color:#c62828}
    ul.rules-list .penalty.negative{color:#2e7d32}
    table{width:100%;border-collapse:collapse;margin-top:20px;font-size:.9rem}
    th,td{border:1px solid #ddd;padding:10px;text-align:center}
    th{background:var(--primary-color);color:#fff;font-weight:700}
    td.team-name{font-weight:bold;text-align:left}
    td.total{font-weight:900;background:#e8f5e9;font-size:1.1rem}
    .countdown,.timer{text-align:center}
    .countdown-container{display:flex;justify-content:center;gap:20px;margin-top:15px}
    .countdown-item{background:var(--secondary-color);padding:10px;border-radius:10px;min-width:80px}
    .countdown-item span{display:block}
    .countdown-number{font-size:2.5rem;font-weight:700;color:var(--primary-color)}
    .countdown-label{font-size:.9rem;color:#777}
    .timer-display{font-size:4rem;font-weight:900;color:var(--primary-color);margin:10px 0}
    .timer-controls button{background:var(--primary-color);color:#fff;border:none;padding:12px 25px;font-size:1rem;border-radius:8px;cursor:pointer;margin:5px;transition:background-color .3s,transform .2s}
    .timer-controls button:hover{background:#0a5227;transform:translateY(-2px)}
    .timer-controls button:disabled{background:#999;cursor:not-allowed}
    .admin-panel{background:var(--text-color);color:#fff;border-radius:15px;padding:25px;margin-top:30px}
    .admin-panel h2,.admin-panel h3{color:#fff;border-color:var(--accent-color)}
    .admin-panel input,.admin-panel select,.admin-panel button{width:100%;padding:12px;margin-bottom:10px;border-radius:5px;border:none;box-sizing:border-box}
    .admin-panel button{background:var(--accent-color);color:var(--text-color);font-weight:bold;cursor:pointer;transition:transform .2s ease}
    .admin-panel button:hover{transform:scale(1.02)}
    #admin-content{display:none}
    .admin-panel button.danger-button{background:var(--danger-color);color:#fff}
    .admin-panel button.danger-button:hover{background:#a32222}
    .admin-panel button.confirm-button{background:#ff3d00;color:#fff}
    .status{font-size:.9rem;margin:.25rem 0 0;opacity:.8}
  </style>
</head>
<body>
  <header class="header">
    <h1>Bockenheim Open</h1>
    <p>Hostet by BAC / Basalt WG</p>
  </header>

  <main class="container">
    <section class="card countdown">
      <h2>Tour Start</h2>
      <div id="countdown-container" class="countdown-container">
        <div class="countdown-item"><span id="days" class="countdown-number">0</span><span class="countdown-label">Tage</span></div>
        <div class="countdown-item"><span id="hours" class="countdown-number">0</span><span class="countdown-label">Stunden</span></div>
        <div class="countdown-item"><span id="minutes" class="countdown-number">0</span><span class="countdown-label">Minuten</span></div>
        <div class="countdown-item"><span id="seconds" class="countdown-number">0</span><span class="countdown-label">Sekunden</span></div>
      </div>
      <p id="countdown-message" style="font-weight:bold;margin-top:15px"></p>
    </section>

    <section class="card" id="current-challenge-card">
      <h2>AKTUELLE CHALLENGE</h2>
      <div id="current-challenge-content">
        <p>Der Admin hat die Tour noch nicht gestartet.</p>
      </div>
      <p id="realtime-status" class="status">⏳ Verbinde mit Firebase…</p>
    </section>

    <section class="card">
      <h2>Die Route & Karte</h2>
      <div id="map"></div>
    </section>

    <section class="card">
      <h2>Die 9 Löcher (Tour-Plan)</h2>
      <div id="stops-list"></div>
    </section>

    <section class="card">
      <h2>Live Leaderboard</h2>
      <div style="overflow-x:auto">
        <table id="leaderboard">
          <thead>
            <tr>
              <th>Team</th>
              <th>Strafen</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>Regelwerk</h2>
      <ul class="rules-list">
        <li>Getränk verschüttet <span class="penalty positive">+2</span></li>
        <li>Hole-in-One (auf ex getrunken) <span class="penalty negative">-1</span></li>
        <li>Loch nicht beendet <span class="penalty positive">+3</span></li>
        <li>Nicht mit dem Partner getrunken (1x Joker) <span class="penalty positive">+3</span></li>
        <li>Party-Hut abgenommen <span class="penalty positive">+1</span></li>
      </ul>
    </section>

    <section class="card timer">
      <h2>10-Sekunden Ex-Counter</h2>
      <div id="timer-display" class="timer-display">10.0</div>
      <div class="timer-controls">
        <button id="timer-start">Start</button>
        <button id="timer-reset">Reset</button>
      </div>
    </section>

    <section class="admin-panel">
      <h2>Admin-Steuerung</h2>
      <div id="login-section">
        <p>Passwort eingeben, um Scores zu verwalten.</p>
        <input type="password" id="admin-password" placeholder="Admin-Passwort" />
        <button onclick="unlockAdmin()">Freischalten</button>
      </div>
      <div id="admin-content">
        <h3>Scores pro Loch</h3>
        <label for="score-team-select">Team auswählen:</label>
        <select id="score-team-select"></select>
        <label for="hole-select">Loch auswählen:</label>
        <select id="hole-select"></select>
        <label for="score-input">Benötigte Schlücke:</label>
        <input type="number" id="score-input" placeholder="Anzahl" />
        <button onclick="updateScore()">Score eintragen</button>

        <hr style="margin:20px 0;border-color:#555" />

        <h3>Strafen & Boni</h3>
        <label for="penalty-team-select">Team auswählen:</label>
        <select id="penalty-team-select"></select>
        <label for="penalty-select">Regel auswählen:</label>
        <select id="penalty-select"></select>
        <button onclick="applyPenalty()">Strafe/Bonus anwenden</button>

        <hr style="margin:20px 0;border-color:#555" />

        <h3>Tour-Steuerung</h3>
        <label for="current-stop-select">Aktuellen Stopp festlegen:</label>
        <select id="current-stop-select"></select>
        <button onclick="setCurrentStop()">Als aktuellen Stopp setzen</button>

        <hr style="margin:20px 0;border-color:#555" />

        <h3>Gefahrenzone</h3>
        <button id="reset-button" class="danger-button" onclick="requestFullReset()">ALLES ZURÜCKSETZEN</button>
        <button id="cancel-reset-button" style="display:none;background-color:#555;color:#fff" onclick="cancelReset()">Abbrechen</button>
      </div>
    </section>
  </main>

  <!-- Firebase + App Script (module) -->
  <script type="module">
    /***********************
     * Firebase Bootstrap  *
     ***********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-analytics.js";
    import { getDatabase, ref, set, update, onValue, get, child } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app-check.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjGadjeasQN1uqjorxx1SCmYCCvMtdFF4",
      authDomain: "bockenheim-open.firebaseapp.com",
      databaseURL: "https://bockenheim-open-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "bockenheim-open",
      storageBucket: "bockenheim-open.firebasestorage.app",
      messagingSenderId: "609147834146",
      appId: "1:609147834146:web:d3324e4e9c061fc290df7b",
      measurementId: "G-GGKRGX6YQE",
    };

    const app = initializeApp(firebaseConfig);
    // Optional Analytics (only works over https + in production origins)
    try { getAnalytics(app); } catch(e) {}

    // Optional App Check (protects your DB from abuse). Create a reCAPTCHA v3 key and add here if you have one.
    try { initializeAppCheck(app, { provider: new ReCaptchaV3Provider("__RECAPTCHA_SITE_KEY__"), isTokenAutoRefreshEnabled: true }); } catch(e) {}

    const auth = getAuth(app);
    const db = getDatabase(app);

    /***********************
     * App State & Config  *
     ***********************/
    const tourConfig = {
      stops: [
        { name: "Start: Basaltstraße 39", lat: 50.1259278, lon: 8.6441328, drink: "Long-Drink", par: 4, address: "Basaltstraße 39" },
        { name: "Dalli Dalli Pilsstübchen", lat: 50.1256647, lon: 8.6436847, drink: "Bier/Appler", par: 3, address: "Grempstraße 4" },
        { name: "Lüsterweibchen", lat: 50.1241143, lon: 8.6414999, drink: "Wein", par: 3, address: "Große Seestraße 49a" },
        { name: "Kiosk am Platz", lat: 50.1244439, lon: 8.6434939, drink: "Shot", par: 1, address: "Kurfürstenpl. 36" },
        { name: "Casa Blanca", lat: 50.1198891, lon: 8.6450849, drink: "Cocktail / Longdrink", par: 4, address: "Adalbertstraße 34" },
        { name: "Zum Tannenbaum", lat: 50.1189258, lon: 8.6463081, drink: "Appler", par: 3, address: "Adalbertstraße 53" },
        { name: "Khan Kiosk", lat: 50.1198055, lon: 8.6487065, drink: "Bier/Appler", par: 3, address: "Leipziger Str. 2" },
        { name: "Extrablatt", lat: 50.1198957, lon: 8.6504733, drink: "Shot", par: 1, address: "Bockenheimer Warte" },
        { name: "Doctor Flotte", lat: 50.1204769, lon: 8.65017, drink: "Bier / Appler / Wein", par: 3, address: "Leipziger Str. 20" }
      ],
      teams: ["Team Alpha","Team Bravo","Team Charlie","Team Delta","Team Echo","Team Foxtrot"],
      adminPassword: "bockenheim",
      rules: [
        { text: "Getränk verschüttet", value: 2 },
        { text: "Hole-in-One (Exen)", value: -1 },
        { text: "Loch nicht beendet", value: 3 },
        { text: "Partner-Regel missachtet", value: 3 },
        { text: "Party-Hut abgenommen", value: 1 }
      ]
    };

    let scores = {};
    let mapMarkers = [];
    let currentStopIndex = -1;

    const DB_PATH_SCORES = "scores";               // scores/{team}/holes/{i} & scores/{team}/penalty
    const DB_PATH_CURRENT_STOP = "currentStopIndex";// number

    /***********************
     * Boot sequence       *
     ***********************/
    document.addEventListener('DOMContentLoaded', () => {
      initCountdown();
      initExCounter();
      initMap();
      initStopsList();
      initLeaderboard();
      initAdminPanel();

      // Sign in anonymously (so we can apply security rules like `auth != null`)
      signInAnonymously(auth).catch(console.error);

      // Once signed in, attach realtime listeners
      onAuthStateChanged(auth, (user)=>{
        if(!user) return;
        attachRealtimeListeners();
      });
    });

    function attachRealtimeListeners(){
      const statusEl = document.getElementById('realtime-status');
      if(statusEl) statusEl.textContent = '🔌 Verbunden — Live-Updates aktiv';

      // Ensure all teams exist locally
      tourConfig.teams.forEach(team => {
        if(!scores[team]) scores[team] = { holes: Array(tourConfig.stops.length).fill(0), penalty: 0 };
      });

      // Scores listener
      onValue(ref(db, DB_PATH_SCORES), (snap)=>{
        const val = snap.val() || {};
        // Merge with defaults so late-joining teams still render correctly
        scores = {};
        tourConfig.teams.forEach(team => {
          const t = val[team] || {};
          scores[team] = {
            holes: Array.isArray(t.holes) ? t.holes.slice(0, tourConfig.stops.length).concat(Array(Math.max(0, tourConfig.stops.length - (t.holes?.length||0))).fill(0)) : Array(tourConfig.stops.length).fill(0),
            penalty: Number.isFinite(t.penalty) ? t.penalty : 0,
          };
        });
        updateLeaderboardView();
      });

      // Current stop listener
      onValue(ref(db, DB_PATH_CURRENT_STOP), (snap)=>{
        const idx = typeof snap.val()==='number' ? snap.val() : -1;
        if(idx !== currentStopIndex){
          currentStopIndex = idx;
          updateCurrentStopView(true);
        }
      });
    }

    /***********************
     * UI helpers          *
     ***********************/
    function initCountdown(){
      const now = new Date();
      const saturday = new Date(now);
      saturday.setDate(now.getDate() + (6 - now.getDay() + 7) % 7);
      saturday.setHours(21,0,0,0);
      const targetDate = saturday.getTime();

      const interval = setInterval(()=>{
        const current = Date.now();
        const distance = targetDate - current;
        if(distance < 0){
          clearInterval(interval);
          document.getElementById('countdown-container').style.display='none';
          document.getElementById('countdown-message').textContent='Die Bockenheim Open haben begonnen! Viel Erfolg!';
          return;
        }
        const days=Math.floor(distance/86400000);
        const hours=Math.floor((distance%86400000)/3600000);
        const minutes=Math.floor((distance%3600000)/60000);
        const seconds=Math.floor((distance%60000)/1000);
        document.getElementById('days').textContent = days;
        document.getElementById('hours').textContent = hours;
        document.getElementById('minutes').textContent = minutes;
        document.getElementById('seconds').textContent = seconds;
      },1000);
    }

    let exTimerInterval;
    function initExCounter(){
      const startBtn = document.getElementById('timer-start');
      const resetBtn = document.getElementById('timer-reset');
      const display = document.getElementById('timer-display');
      startBtn.addEventListener('click', ()=>{
        startBtn.disabled = true;
        let endTime = Date.now() + 10000;
        exTimerInterval = setInterval(()=>{
          const timeLeft = endTime - Date.now();
          if(timeLeft <= 0){
            clearInterval(exTimerInterval);
            display.textContent = '0.0';
            startBtn.disabled = false;
            return;
          }
          display.textContent = (timeLeft/1000).toFixed(1);
        },100);
      });
      resetBtn.addEventListener('click', ()=>{
        clearInterval(exTimerInterval);
        display.textContent = '10.0';
        startBtn.disabled = false;
      });
    }

    function initMap(){
      const map = L.map('map').setView([50.123,8.646],16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);
      const routeCoordinates = tourConfig.stops.map(s=>[s.lat,s.lon]);
      tourConfig.stops.forEach((stop, index)=>{
        const holeNum = index + 1;
        const icon = L.divIcon({
          html:`<div style="background-color: var(--primary-color); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${holeNum}</div>`,
          className:'', iconSize:[30,30], iconAnchor:[15,15]
        });
        const marker = L.marker([stop.lat,stop.lon],{icon}).addTo(map)
          .bindPopup(`<b>Loch ${holeNum}: ${stop.name}</b><br>${stop.address}<br><i>Getränk: ${stop.drink}</i><br><b>Par: ${stop.par}</b>`);
        mapMarkers.push(marker);
      });
      L.polyline(routeCoordinates,{color:'var(--primary-color)',weight:4,opacity:.8}).addTo(map);
    }

    function initStopsList(){
      const el = document.getElementById('stops-list');
      el.innerHTML = '';
      tourConfig.stops.forEach((stop, index)=>{
        const holeNum = index + 1;
        const d = document.createElement('div');
        d.className = 'stop';
        d.id = `stop-list-item-${index}`;
        d.innerHTML = `<div class="stop-info"><div><h3>${holeNum}. ${stop.name}</h3><p class="drink">Getränk: ${stop.drink}</p></div><div class="par">${stop.par}<span>PAR</span></div></div>`;
        el.appendChild(d);
      });
    }

    function initLeaderboard(){
      const thead = document.querySelector('#leaderboard thead tr');
      thead.innerHTML = '<th>Rang</th><th>Team</th>' + tourConfig.stops.map((_,i)=>`<th>${i+1}</th>`).join('') + '<th>Strafen</th><th>Total</th>';
      tourConfig.teams.forEach(team=>{ if(!scores[team]) scores[team] = { holes:Array(tourConfig.stops.length).fill(0), penalty:0 }; });
    }

    function initAdminPanel(){
      const scoreTeamSelect = document.getElementById('score-team-select');
      const penaltyTeamSelect = document.getElementById('penalty-team-select');
      const holeSelect = document.getElementById('hole-select');
      const currentStopSelect = document.getElementById('current-stop-select');
      const penaltySelect = document.getElementById('penalty-select');
      [scoreTeamSelect, penaltyTeamSelect, holeSelect, currentStopSelect, penaltySelect].forEach(el=> el.innerHTML='');
      tourConfig.teams.forEach(team=>{
        const o = document.createElement('option'); o.value = team; o.textContent = team;
        scoreTeamSelect.appendChild(o.cloneNode(true));
        penaltyTeamSelect.appendChild(o);
      });
      tourConfig.stops.forEach((stop, idx)=>{
        const o = document.createElement('option'); o.value = idx; o.textContent = `Loch ${idx+1}: ${stop.name}`;
        holeSelect.appendChild(o.cloneNode(true));
        currentStopSelect.appendChild(o);
      });
      tourConfig.rules.forEach(rule=>{
        const o = document.createElement('option'); o.value = rule.value; o.textContent = `${rule.text} (${rule.value>0?'+':''}${rule.value})`;
        penaltySelect.appendChild(o);
      });
    }

    function updateLeaderboardView(){
      const data = tourConfig.teams.map(team=>{
        const t = scores[team] || { holes:Array(tourConfig.stops.length).fill(0), penalty:0 };
        const totalHoles = t.holes.reduce((a,b)=>a+b,0);
        const total = totalHoles + t.penalty;
        return { name: team, holes: t.holes, penalty: t.penalty, total };
      }).sort((a,b)=> a.total - b.total);

      const tbody = document.querySelector('#leaderboard tbody');
      tbody.innerHTML = '';
      data.forEach((row, i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><b>${i+1}.</b></td><td class="team-name">${row.name}</td>`
          + row.holes.map(s=>`<td>${s>0?s:'-'}</td>`).join('')
          + `<td>${row.penalty}</td><td class="total">${row.total}</td>`;
        tbody.appendChild(tr);
      });
    }

    function updateCurrentStopView(shouldScroll){
      if(currentStopIndex < 0 || currentStopIndex >= tourConfig.stops.length){
        document.getElementById('current-challenge-card').style.display='none';
        return;
      }
      const stop = tourConfig.stops[currentStopIndex];
      const holeNum = currentStopIndex + 1;
      const card = document.getElementById('current-challenge-card');
      document.getElementById('current-challenge-content').innerHTML = `<h3>Loch ${holeNum}: ${stop.name}</h3><p><strong>Getränk:</strong> ${stop.drink}</p><div class="par">${stop.par}<span>PAR</span></div>`;
      card.style.display = 'block';
      document.querySelectorAll('.stop').forEach(el=> el.classList.remove('active'));
      const active = document.getElementById(`stop-list-item-${currentStopIndex}`);
      if(active){
        active.classList.add('active');
        if(shouldScroll) active.scrollIntoView({ behavior:'smooth', block:'center' });
      }
      mapMarkers.forEach((marker, idx)=>{
        const newSize = idx === currentStopIndex ? 40 : 30;
        const newAnchor = idx === currentStopIndex ? 20 : 15;
        const html = `<div style="background-color:${idx===currentStopIndex?'var(--accent-color)':'var(--primary-color)'};color:${idx===currentStopIndex?'black':'white'};border-radius:50%;width:${newSize}px;height:${newSize}px;display:flex;align-items:center;justify-content:center;font-weight:bold;border:${idx===currentStopIndex?3:2}px solid white;box-shadow:0 2px 10px rgba(0,0,0,0.5);z-index:1000;">${idx+1}</div>`;
        marker.setIcon(L.divIcon({ html, className:'', iconSize:[newSize,newSize], iconAnchor:[newAnchor,newAnchor] }));
      });
    }

    /***********************
     * Admin actions -> DB *
     ***********************/
    window.unlockAdmin = function(){
      if(document.getElementById('admin-password').value === tourConfig.adminPassword){
        document.getElementById('login-section').style.display='none';
        document.getElementById('admin-content').style.display='block';
      } else { alert('Falsches Passwort!'); }
    }

    window.updateScore = async function(){
      const team = document.getElementById('score-team-select').value;
      const hole = parseInt(document.getElementById('hole-select').value);
      const scoreInput = document.getElementById('score-input');
      const val = parseInt(scoreInput.value);
      if(team && !Number.isNaN(hole) && !Number.isNaN(val) && val >= 0){
        const updates = {};
        updates[`${DB_PATH_SCORES}/${team}/holes/${hole}`] = val;
        await update(ref(db), updates);
        scoreInput.value = '';
      } else { alert('Bitte eine gültige Zahl für die Schlücke eintragen.'); }
    }

    window.applyPenalty = async function(){
      const team = document.getElementById('penalty-team-select').value;
      const delta = parseInt(document.getElementById('penalty-select').value);
      if(team && !Number.isNaN(delta)){
        const snap = await get(child(ref(db), `${DB_PATH_SCORES}/${team}/penalty`));
        const current = Number(snap.val()||0);
        await set(ref(db, `${DB_PATH_SCORES}/${team}/penalty`), current + delta);
      }
    }

    window.setCurrentStop = async function(){
      const idx = parseInt(document.getElementById('current-stop-select').value);
      if(!Number.isNaN(idx)) await set(ref(db, DB_PATH_CURRENT_STOP), idx);
    }

    window.requestFullReset = function(){
      const resetButton = document.getElementById('reset-button');
      const cancelButton = document.getElementById('cancel-reset-button');
      resetButton.textContent = 'SICHER? NOCHMAL KLICKEN ZUM LÖSCHEN!';
      resetButton.classList.remove('danger-button');
      resetButton.classList.add('confirm-button');
      resetButton.setAttribute('onclick','executeFullReset()');
      cancelButton.style.display = 'block';
    }

    window.cancelReset = function(){
      const resetButton = document.getElementById('reset-button');
      const cancelButton = document.getElementById('cancel-reset-button');
      resetButton.textContent = 'ALLES ZURÜCKSETZEN';
      resetButton.classList.remove('confirm-button');
      resetButton.classList.add('danger-button');
      resetButton.setAttribute('onclick','requestFullReset()');
      cancelButton.style.display = 'none';
    }

    window.executeFullReset = async function(){
      // Remove from DB
      await set(ref(db, DB_PATH_SCORES), null);
      await set(ref(db, DB_PATH_CURRENT_STOP), -1);
      // Soft UI reset
      scores = {};
      currentStopIndex = -1;
      updateLeaderboardView();
      updateCurrentStopView(false);
    }
  </script>
</body>
</html>
