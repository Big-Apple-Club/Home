<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Bockenheim Open 2025</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet" />

  <style>
    :root{
      --primary-color:#0d6b33; --secondary-color:#f5f5f5; --accent-color:#d4af37;
      --text-color:#333; --card-bg:#fff; --danger-color:#c62828;
      --highlight:#fffbef; --highlight-border:#d4af37;
      --over:#c62828; --under:#2e7d32; --on:#111;
    }
    body{font-family:'Montserrat',sans-serif;margin:0;background:var(--secondary-color);color:var(--text-color);line-height:1.6}
    @keyframes fadeInDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
    .header{background:var(--primary-color);
      background-image:
        linear-gradient(135deg,rgba(255,255,255,.05) 25%,transparent 25%),
        linear-gradient(225deg,rgba(255,255,255,.05) 25%,transparent 25%),
        linear-gradient(45deg,rgba(255,255,255,.05) 25%,transparent 25%),
        linear-gradient(315deg,rgba(255,255,255,.05) 25%,var(--primary-color) 25%);
      background-position:10px 0,10px 0,0 0,0 0;background-size:20px 20px;background-repeat:repeat;
      color:#fff;text-align:center;padding:2.5rem 1rem 3.5rem;clip-path:polygon(0 0,100% 0,100% 85%,50% 100%,0 85%);margin-bottom:-3rem;position:relative;z-index:10}
    .header h1{margin:0;font-size:clamp(2.2rem,7vw,3.6rem);font-weight:900;text-transform:uppercase;letter-spacing:4px;text-shadow:3px 3px 10px rgba(0,0,0,.5);animation:fadeInDown 1s ease-out}
    .header p{margin:.5rem 0 0;font-size:clamp(.95rem,3.5vw,1.1rem);opacity:.9;font-weight:700}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .card{background:var(--card-bg);border-radius:15px;padding:22px;margin-bottom:22px;box-shadow:0 10px 20px rgba(0,0,0,.08);border-left:5px solid var(--primary-color)}
    h2{font-size:1.6rem;font-weight:700;color:var(--primary-color);border-bottom:3px solid var(--accent-color);padding-bottom:8px;margin-top:0}
    #map{height:460px;width:100%;border-radius:10px}

    .stop{padding:14px;margin-bottom:16px;border-radius:10px;background:#fafafa;border:1px solid #eee}
    .stop-info{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .stop h3{margin:0;font-size:1.1rem}
    .drink{font-style:italic;color:#555}
    .par{font-weight:900;font-size:2.2rem;color:var(--primary-color);line-height:1}
    .par span{font-size:.9rem;font-weight:400;display:block;color:#777}
    .stop.active{background:var(--highlight);border-left:5px solid var(--highlight-border);transform:scale(1.02);transition:all .2s ease}

    #current-challenge-card{display:none;text-align:center;border-color:var(--highlight-border);background:var(--highlight)}
    #current-challenge-card h2{font-size:1.3rem}
    #current-challenge-card .par{font-size:2.6rem;margin-top:.6rem}

    ul.rules-list{list-style:none;padding:0;margin:0}
    ul.rules-list li{padding:8px 0;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    ul.rules-list li:last-child{border-bottom:none}
    .penalty{font-weight:700}
    .penalty.positive{color:#c62828} .penalty.negative{color:#2e7d32}

    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:.9rem}
    th,td{border:1px solid #ddd;padding:8px;text-align:center}
    th{background:var(--primary-color);color:#fff;font-weight:700}
    td.team-name{text-align:left;font-weight:700}
    td.total{font-weight:900;background:#e8f5e9}

    /* kompakter Countdown */
    .countdown{text-align:center}
    .countdown-container{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:8px}
    .countdown-item{background:#fff;border:1px solid #eee;border-radius:8px;min-width:66px;padding:6px 8px}
    .countdown-number{font-size:1.6rem;font-weight:800;color:var(--primary-color);line-height:1}
    .countdown-label{font-size:.75rem;color:#777;margin-top:2px}

    .timer{text-align:center}
    .timer-display{font-size:3rem;font-weight:900;color:var(--primary-color);margin:8px 0}
    .timer-controls button{background:var(--primary-color);color:#fff;border:none;padding:10px 18px;font-size:.95rem;border-radius:8px;cursor:pointer;margin:4px;transition:background-color .3s,transform .2s}
    .timer-controls button:hover{background:#0a5227;transform:translateY(-2px)}
    .timer-controls button:disabled{background:#999;cursor:not-allowed}

    .admin-panel{background:var(--text-color);color:#fff;border-radius:15px;padding:22px;margin-top:24px}
    .admin-panel h2,.admin-panel h3{color:#fff;border-color:var(--accent-color)}
    .admin-panel input,.admin-panel select,.admin-panel button{width:100%;padding:10px;margin-bottom:10px;border-radius:6px;border:none;box-sizing:border-box}
    .admin-panel button{background:var(--accent-color);color:var(--text-color);font-weight:800;cursor:pointer;transition:transform .15s ease}
    .admin-panel button:hover{transform:scale(1.02)}
    #admin-content{display:none}
    .danger-button{background:var(--danger-color)!important;color:#fff}
    .confirm-button{background:#ff3d00!important;color:#fff}

    /* Farben f√ºr +/-/0 im Leaderboard */
    .rel-pos{color:var(--over);font-weight:700}
    .rel-neg{color:var(--under);font-weight:700}
    .rel-zero{color:var(--on);font-weight:700}
  </style>
</head>
<body>
<header class="header">
  <h1>Bockenheim Open</h1>
  <p>Hostet by BAC / Basalt WG</p>
</header>

<main class="container">
  <!-- Countdown -->
  <section class="card countdown">
    <h2>Tour Start</h2>
    <div id="countdown-container" class="countdown-container">
      <div class="countdown-item"><div id="days" class="countdown-number">0</div><div class="countdown-label">Tage</div></div>
      <div class="countdown-item"><div id="hours" class="countdown-number">0</div><div class="countdown-label">Std</div></div>
      <div class="countdown-item"><div id="minutes" class="countdown-number">0</div><div class="countdown-label">Min</div></div>
      <div class="countdown-item"><div id="seconds" class="countdown-number">0</div><div class="countdown-label">Sek</div></div>
    </div>
    <p id="countdown-message" style="font-weight:700;margin-top:8px;"></p>
  </section>

  <!-- Aktuelle Challenge -->
  <section class="card" id="current-challenge-card">
    <h2>AKTUELLE CHALLENGE</h2>
    <div id="current-challenge-content">
      <p>Der Admin hat die Tour noch nicht gestartet.</p>
    </div>
  </section>

  <!-- Karte -->
  <section class="card">
    <h2>Die Route & Karte</h2>
    <div id="map"></div>
  </section>

  <!-- Tour-Plan -->
  <section class="card">
    <h2>Die 9 L√∂cher (Tour-Plan)</h2>
    <div id="stops-list"></div>
  </section>

  <!-- Leaderboard -->
  <section class="card">
    <h2>Live Leaderboard</h2>
    <div style="overflow-x:auto">
      <table id="leaderboard">
        <thead>
          <tr>
            <th>Team</th>
            <th>Strafen</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Regeln -->
  <section class="card">
    <h2>Regelwerk</h2>
    <ul class="rules-list">
      <li>Getr√§nk versch√ºttet <span class="penalty positive">+2</span></li>
      <li>Hole-in-One (Exen) <span class="penalty negative">-2</span></li>
      <li>Loch nicht beendet <span class="penalty positive">+3</span></li>
      <li>Nicht mit dem Partner getrunken (1x Joker) <span class="penalty positive">+3</span></li>
      <li>Party-Hut abgenommen <span class="penalty positive">+1</span></li>
    </ul>
  </section>

  <!-- Timer -->
  <section class="card timer">
    <h2>10-Sekunden Ex-Counter</h2>
    <div id="timer-display" class="timer-display">10.0</div>
    <div class="timer-controls">
      <button id="timer-start">Start</button>
      <button id="timer-reset">Reset</button>
    </div>
  </section>

  <!-- Admin -->
  <section class="admin-panel">
    <h2>Admin-Steuerung</h2>

    <div id="login-section">
      <p>Passwort eingeben, um Scores zu verwalten.</p>
      <input type="password" id="admin-password" placeholder="Admin-Passwort" />
      <button onclick="unlockAdmin()">Freischalten</button>
    </div>

    <div id="admin-content">
      <h3>Scores pro Loch</h3>
      <label for="score-team-select">Team ausw√§hlen:</label>
      <select id="score-team-select"></select>

      <label for="hole-select">Loch ausw√§hlen:</label>
      <select id="hole-select"></select>

      <label for="score-input">Ben√∂tigte Schl√ºcke (Gesamt):</label>
      <input type="number" id="score-input" placeholder="Anzahl" min="0" />
      <button onclick="updateScore()">Score eintragen</button>

      <hr style="margin:16px 0;border-color:#555">

      <h3>Strafen & Boni</h3>
      <label for="penalty-team-select">Team ausw√§hlen:</label>
      <select id="penalty-team-select"></select>
      <label for="penalty-select">Regel ausw√§hlen:</label>
      <select id="penalty-select"></select>
      <button onclick="applyPenalty()">Strafe/Bonus anwenden</button>

      <hr style="margin:16px 0;border-color:#555">

      <h3>Tour-Steuerung</h3>
      <label for="current-stop-select">Aktuellen Stopp festlegen:</label>
      <select id="current-stop-select"></select>
      <button onclick="setCurrentStop()">Als aktuellen Stopp setzen</button>

      <hr style="margin:16px 0;border-color:#555">

      <!-- üîß Team-Namen bearbeiten (NEU) -->
      <h3>Team-Namen bearbeiten</h3>
      <div id="team-name-editor">
        <input type="text" id="team-name-0" placeholder="Team 1" />
        <input type="text" id="team-name-1" placeholder="Team 2" />
        <input type="text" id="team-name-2" placeholder="Team 3" />
        <input type="text" id="team-name-3" placeholder="Team 4" />
        <button id="save-team-names" onclick="saveTeamNames()">Namen speichern</button>
        <p id="team-name-hint" style="font-size:.85rem;opacity:.85;margin-top:6px;">
          Tipp: Namen m√ºssen eindeutig sein. Beim Speichern werden vorhandene Scores automatisch mitumgezogen.
        </p>
      </div>

      <hr style="margin:16px 0;border-color:#555">

      <h3>Gefahrenzone</h3>
      <button id="reset-button" class="danger-button" onclick="requestFullReset()">ALLES ZUR√úCKSETZEN</button>
      <button id="cancel-reset-button" style="display:none;background:#555;color:#fff" onclick="cancelReset()">Abbrechen</button>
    </div>
  </section>
</main>

<script>
  const tourConfig = {
    stops: [
      { name:"Start: Basaltstra√üe 39", lat:50.1259278, lon:8.6441328, drink:"Long-Drink", par:4, address:"Basaltstra√üe 39" },
      { name:"Dalli Dalli Pilsst√ºbchen", lat:50.1256647, lon:8.6436847, drink:"Bier/Appler", par:3, address:"Grempstra√üe 4" },
      { name:"L√ºsterweibchen", lat:50.1241143, lon:8.6414999, drink:"Wein", par:3, address:"Gro√üe Seestra√üe 49a" },
      { name:"Kiosk am Platz", lat:50.1244439, lon:8.6434939, drink:"Shot", par:1, address:"Kurf√ºrstenpl. 36" },
      { name:"Casa Blanca", lat:50.1198891, lon:8.6450849, drink:"Cocktail / Longdrink", par:4, address:"Adalbertstra√üe 34" },
      { name:"Zum Tannenbaum", lat:50.1189258, lon:8.6463081, drink:"Appler", par:3, address:"Adalbertstra√üe 53" },
      { name:"Khan Kiosk", lat:50.1198055, lon:8.6487065, drink:"Bier/Appler", par:3, address:"Leipziger Str. 2" },
      { name:"Extrablatt", lat:50.1198957, lon:8.6504733, drink:"Shot", par:1, address:"Bockenheimer Warte" },
      { name:"Doctor Flotte", lat:50.1204769, lon:8.65017, drink:"Bier / Appler / Wein", par:3, address:"Leipziger Str. 20" }
    ],
    teams:["Team Alpha","Team Bravo","Team Charlie","Team Delta"], // Startzustand (bearbeitbar im Admin)
    adminPassword:"bockenheim",
    rules:[
      { text:"Getr√§nk versch√ºttet", value:2 },
      { text:"Hole-in-One (Exen)", value:-2 },
      { text:"Loch nicht beendet", value:3 },
      { text:"Partner-Regel missachtet", value:3 },
      { text:"Party-Hut abgenommen", value:1 }
    ]
  };

  window.scores={}; window.currentStopIndex=-1;

  document.addEventListener('DOMContentLoaded',()=>{initCountdown();initExCounter();initMap();initStopsList();initLeaderboard();initAdminPanel();});

  let mapMarkers=[];
  function initMap(){
    const map = L.map('map').setView([50.123, 8.646], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(map);
    const route = tourConfig.stops.map(s=>[s.lat,s.lon]);
    tourConfig.stops.forEach((stop,i)=>{
      const hole=i+1;
      const icon = L.divIcon({ html:`<div style="background-color: var(--primary-color); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;">${hole}</div>`, className:"", iconSize:[30,30], iconAnchor:[15,15] });
      const m = L.marker([stop.lat, stop.lon], { icon }).addTo(map)
        .bindPopup(`<b>Loch ${hole}: ${stop.name}</b><br>${stop.address}<br><i>Getr√§nk: ${stop.drink}</i><br><b>Par: ${stop.par}</b>`);
      mapMarkers.push(m);
    });
    L.polyline(route,{ color:'var(--primary-color)', weight:4, opacity:.8 }).addTo(map);

    /* ü™¶ Grabstein-Emoji Marker (nur Anzeige) */
    const tombIcon = L.divIcon({
      html: `<div style="font-size:28px; line-height:28px;">ü™¶</div>`,
      className: "",
      iconSize: [28, 28],
      iconAnchor: [14, 14]
    });
    L.marker([50.124501, 8.642075], { icon: tombIcon, zIndexOffset: 1000 }).addTo(map).bindPopup("ü™¶ Spot 1");
    L.marker([50.119853, 8.645073], { icon: tombIcon, zIndexOffset: 1000 }).addTo(map).bindPopup("ü™¶ Spot 2");
    L.marker([50.120368, 8.650175], { icon: tombIcon, zIndexOffset: 1000 }).addTo(map).bindPopup("ü™¶ Spot 3");
  }

  function initStopsList(){
    const el=document.getElementById('stops-list'); el.innerHTML='';
    tourConfig.stops.forEach((stop,i)=>{
      const hole=i+1;
      const div=document.createElement('div'); div.className='stop'; div.id=`stop-list-item-${i}`;
      div.innerHTML=`<div class="stop-info"><div><h3>${hole}. ${stop.name}</h3><p class="drink">Getr√§nk: ${stop.drink}</p></div><div class="par">${stop.par}<span>PAR</span></div></div>`;
      el.appendChild(div);
    });
  }

  function initLeaderboard(){
    const thead=document.querySelector('#leaderboard thead tr');
    thead.innerHTML='<th>Rang</th><th>Team</th>';
    for(let i=1;i<=tourConfig.stops.length;i++){ const th=document.createElement('th'); th.textContent=String(i); thead.appendChild(th); }
    thead.innerHTML += '<th>Strafen</th><th>Total</th>';
  }

  function updateLeaderboardView(){
    const tbody=document.querySelector('#leaderboard tbody'); tbody.innerHTML='';

    // Wir verwenden die dynamische TEAM_LIST (wird unten im Firebase-Block gepflegt)
    const teamsToShow = (window.TEAM_LIST && window.TEAM_LIST.length) ? window.TEAM_LIST : tourConfig.teams;

    const rows = teamsToShow.map((team) => {
      const teamData = (window.scores && window.scores[team]) || { holes:Array(tourConfig.stops.length).fill(0), penalty:0 };

      let sumRel = 0;
      const relPerHole = teamData.holes.map((raw, i) => {
        const v = Number(raw) || 0;
        if (v <= 0) return null; // nicht gewertet
        const par2 = (tourConfig.stops[i]?.par || 0) * 2;
        const rel = v - par2; // Abweichung gg√º. PAR*2
        sumRel += rel;
        return rel;
      });

      const penalty = Number(teamData.penalty) || 0;
      const total = sumRel + penalty;
      return { name: team, relPerHole, penalty, total };
    }).sort((a,b)=>a.total-b.total);

    rows.forEach((row, rank) => {
      const tr = document.createElement('tr');

      const holesCells = row.relPerHole.map((rel) => {
        if (rel === null) return `<td>-</td>`;
        const cls = rel > 0 ? 'rel-pos' : (rel < 0 ? 'rel-neg' : 'rel-zero');
        const txt = rel > 0 ? `+${rel}` : `${rel}`;
        return `<td class="${cls}">${txt}</td>`;
      }).join('');

      tr.innerHTML = `
        <td><b>${rank + 1}.</b></td>
        <td class="team-name">${row.name}</td>
        ${holesCells}
        <td>${row.penalty}</td>
        <td class="total">${row.total}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function updateCurrentStopView(scrollIntoView){
    const card=document.getElementById('current-challenge-card');
    const content=document.getElementById('current-challenge-content');
    const i=window.currentStopIndex;
    if (i < 0 || i >= tourConfig.stops.length){
      card.style.display='none';
      document.querySelectorAll('.stop').forEach(el=>el.classList.remove('active'));
      return;
    }
    const stop=tourConfig.stops[i]; const n=i+1;
    content.innerHTML = `<h3>Loch ${n}: ${stop.name}</h3><p><strong>Getr√§nk:</strong> ${stop.drink}</p><div class="par">${stop.par}<span>PAR</span></div>`;
    card.style.display='block';

    document.querySelectorAll('.stop').forEach(el=>el.classList.remove('active'));
    const active=document.getElementById(`stop-list-item-${i}`); if(active){ active.classList.add('active'); if(scrollIntoView) active.scrollIntoView({behavior:'smooth',block:'center'}); }

    mapMarkers.forEach((m,idx)=>{
      const size = idx===i ? 40 : 30, anchor = idx===i ? 20 : 15;
      const html = `<div style="background-color:${idx===i?'var(--accent-color)':'var(--primary-color)'};color:${idx===i?'black':'white'};border-radius:50%;width:${size}px;height:${size}px;display:flex;align-items:center;justify-content:center;font-weight:bold;border:${idx===i?3:2}px solid white;">${idx+1}</div>`;
      m.setIcon(L.divIcon({ html, className:'', iconSize:[size,size], iconAnchor:[anchor,anchor] }));
    });
  }

  function initCountdown(){
    const now=new Date(); const saturday=new Date(now);
    saturday.setDate(now.getDate()+((6-now.getDay()+7)%7)); saturday.setHours(21,0,0,0);
    const target=saturday.getTime();
    const iv=setInterval(()=>{
      const d=target-Date.now(); if(d<0){ clearInterval(iv); document.getElementById('countdown-container').style.display='none'; document.getElementById('countdown-message').textContent='Die Bockenheim Open haben begonnen! Viel Erfolg!'; return; }
      const dd=Math.floor(d/(1000*60*60*24));
      const hh=Math.floor((d%(1000*60*60*24))/(1000*60*60));
      const mm=Math.floor((d%(1000*60*60))/(1000*60));
      const ss=Math.floor((d%(1000*60))/1000);
      document.getElementById('days').textContent=dd;
      document.getElementById('hours').textContent=hh;
      document.getElementById('minutes').textContent=mm;
      document.getElementById('seconds').textContent=ss;
    },1000);
  }
  let exTimerInterval;
  function initExCounter(){
    const start=document.getElementById('timer-start');
    const reset=document.getElementById('timer-reset');
    const disp=document.getElementById('timer-display');
    start.addEventListener('click', ()=>{
      start.disabled=true; const end=Date.now()+10000;
      exTimerInterval=setInterval(()=>{
        const left=end-Date.now();
        if (left<=0){ clearInterval(exTimerInterval); disp.textContent='0.0'; start.disabled=false; return; }
        disp.textContent=(left/1000).toFixed(1);
      },100);
    });
    reset.addEventListener('click', ()=>{ clearInterval(exTimerInterval); disp.textContent='10.0'; start.disabled=false; });
  }

  function initAdminPanel(){
    const tSel=document.getElementById('score-team-select');
    const pSel=document.getElementById('penalty-team-select');
    const hSel=document.getElementById('hole-select');
    const cSel=document.getElementById('current-stop-select');
    const rSel=document.getElementById('penalty-select');

    [tSel,pSel,hSel,cSel,rSel].forEach(el=>el.innerHTML='');

    const list = (window.TEAM_LIST && window.TEAM_LIST.length) ? window.TEAM_LIST : tourConfig.teams;

    list.forEach(t=>{ tSel.appendChild(new Option(t,t)); pSel.appendChild(new Option(t,t)); });
    tourConfig.stops.forEach((s,i)=>{ const o=new Option(`Loch ${i+1}: ${s.name}`, i); hSel.appendChild(o.cloneNode(true)); cSel.appendChild(o); });
    tourConfig.rules.forEach(r=> rSel.appendChild(new Option(`${r.text} (${r.value>0?'+':''}${r.value})`, r.value)));

    // Team-Name Editor bef√ºllen
    const inputs=[0,1,2,3].map(i=>document.getElementById(`team-name-${i}`));
    for(let i=0;i<inputs.length;i++){ inputs[i].value = list[i] || `Team ${i+1}`; }
  }

  window.unlockAdmin = function(){
    const pw=document.getElementById('admin-password').value;
    if (pw===tourConfig.adminPassword){ document.getElementById('login-section').style.display='none'; document.getElementById('admin-content').style.display='block'; }
    else alert('Falsches Passwort!');
  };
</script>

<!-- ===== Firebase + Firestore (Realtime + Team-Name-Editor) ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDX5k40Sh4PPIAB0AlaUOAO5w_J9kkTetU",
    authDomain: "bockenheimopen.firebaseapp.com",
    projectId: "bockenheimopen",
    storageBucket: "bockenheimopen.firebasestorage.app",
    messagingSenderId: "1041085407769",
    appId: "1:1041085407769:web:4e69958e8adf684b10c088",
    measurementId: "G-ZBHWE97Z0G"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);

  const EVENT_ID = "bockenheim-open-2025";
  const HOLES = window.tourConfig?.stops?.length ?? 9;
  // dynamische Teamliste (wird von Firestore geladen/√ºberschrieben)
  window.TEAM_LIST = (window.tourConfig?.teams ?? []).slice();

  const teamsCol = collection(db, "events", EVENT_ID, "teams");
  const eventDoc = doc(db, "events", EVENT_ID);
  const holesArray = (n=HOLES) => Array(n).fill(0);

  const log=(...a)=>console.log("[BO-Firestore]",...a);
  const err=(...a)=>console.error("[BO-Firestore]",...a);

  signInAnonymously(auth).catch(err);
  onAuthStateChanged(auth, async (user)=>{
    if(!user) return;
    log("angemeldet (anonymous):", user.uid);
    await ensureEventDoc();
    await loadTeamNamesFromEvent();  // TEAM_LIST aus Firestore ziehen oder initial schreiben
    await syncTeamsToList();         // sicherstellen, dass alle TEAM_LIST-Dokumente existieren / gepaddet sind
    attachRealtime();
  });

  async function ensureEventDoc(){
    const snap = await getDoc(eventDoc);
    if (!snap.exists()) {
      await setDoc(eventDoc, { currentStopIndex: -1, teamNames: window.TEAM_LIST });
    }
  }

  async function loadTeamNamesFromEvent(){
    const snap = await getDoc(eventDoc);
    const data = snap.data()||{};
    if (Array.isArray(data.teamNames) && data.teamNames.length){
      window.TEAM_LIST = data.teamNames.slice(0,4); // 4 Teams
    } else {
      // initial schreiben
      await setDoc(eventDoc, { teamNames: window.TEAM_LIST }, { merge:true });
    }
    // Admin-Panel Selects + Inputs aktualisieren
    if (typeof initAdminPanel === "function") initAdminPanel();
  }

  async function syncTeamsToList(){
    const snap = await getDocs(teamsCol);
    const inDb = new Map();
    snap.forEach(d=>inDb.set(d.id, d.ref));
    const ops = [];

    // fehlende anlegen & vorhandene auf HOLES-L√§nge padden
    for (const name of window.TEAM_LIST){
      if (!inDb.has(name)){
        ops.push(setDoc(doc(db,"events",EVENT_ID,"teams",name), { name, holes:holesArray(), penalty:0 }, { merge:true }));
      } else {
        const r=inDb.get(name);
        const ds=await getDoc(r);
        const data=ds.data()||{};
        const arr=Array.isArray(data.holes)? data.holes.slice(0,HOLES).concat(holesArray(HOLES-(data.holes?.length||0))) : holesArray();
        ops.push(setDoc(r, { holes:arr, penalty:Number.isFinite(data.penalty)?data.penalty:0, name:data.name||name }, { merge:true }));
      }
    }

    await Promise.all(ops);
  }

  function attachRealtime(){
    // Teams -> Scores in UI
    onSnapshot(teamsCol, (snap)=>{
      const next = {};
      // default: 0en
      window.TEAM_LIST.forEach(t=> next[t]={ holes:holesArray(), penalty:0 });

      snap.forEach(d=>{
        const data=d.data()||{};
        const name=d.id; // Dokument-ID als Team-Name (stabil)
        if (!window.TEAM_LIST.includes(name)) return;
        const holes = Array.isArray(data.holes)
          ? data.holes.slice(0,HOLES).concat(holesArray(HOLES-(data.holes?.length||0)))
          : holesArray();
        const penalty = Number.isFinite(data.penalty) ? data.penalty : 0;
        next[name] = { holes, penalty };
      });

      window.scores = next;
      if (typeof window.updateLeaderboardView === "function") window.updateLeaderboardView();
      // Admin-Selects neu aufbauen (falls Namen ge√§ndert wurden)
      if (typeof initAdminPanel === "function") initAdminPanel();
    }, err);

    // aktueller Stop
    onSnapshot(eventDoc, (docSnap)=>{
      const st=docSnap.data()||{ currentStopIndex:-1 };
      window.currentStopIndex = Number.isFinite(st.currentStopIndex) ? st.currentStopIndex : -1;
      if (Array.isArray(st.teamNames) && st.teamNames.length){
        window.TEAM_LIST = st.teamNames.slice(0,4);
      }
      if (typeof window.updateCurrentStopView === "function") window.updateCurrentStopView(false);
      const sel=document.getElementById('current-stop-select'); if (sel) sel.value=String(window.currentStopIndex);
      if (typeof initAdminPanel === "function") initAdminPanel();
    }, err);

    // Admin-Aktionen
    window.updateScore = async function(){
      const team = document.getElementById("score-team-select").value;
      const hole = parseInt(document.getElementById("hole-select").value,10);
      const val  = parseInt(document.getElementById("score-input").value,10);
      if(!team || isNaN(hole) || hole<0 || hole>=HOLES || isNaN(val) || val<0){ alert("Bitte g√ºltige Zahl eingeben."); return; }
      const ref = doc(db,"events",EVENT_ID,"teams",team);
      const snap = await getDoc(ref);
      const base = snap.exists()? snap.data() : { name:team, holes:holesArray(), penalty:0 };
      const holes = Array.isArray(base.holes)? base.holes : holesArray();
      holes[hole] = val;
      await setDoc(ref, { name:team, holes, penalty:base.penalty||0 }, { merge:true });
      document.getElementById("score-input").value = "";
    };

    window.applyPenalty = async function(){
      const team  = document.getElementById('penalty-team-select').value;
      const delta = parseInt(document.getElementById('penalty-select').value,10);
      if(!team || isNaN(delta)) return;
      const ref = doc(db,"events",EVENT_ID,"teams",team);
      const snap = await getDoc(ref);
      const base = snap.exists()? snap.data() : { name:team, holes:holesArray(), penalty:0 };
      await setDoc(ref, { name:team, holes:base.holes||holesArray(), penalty:(base.penalty||0)+delta }, { merge:true });
    };

    window.setCurrentStop = async function(){
      const idx = parseInt(document.getElementById('current-stop-select').value,10);
      if (isNaN(idx)) return;
      await setDoc(eventDoc, { currentStopIndex: idx }, { merge:true });
    };

    window.requestFullReset = function(){
      const reset=document.getElementById('reset-button'), cancel=document.getElementById('cancel-reset-button');
      reset.textContent='SICHER? NOCHMAL KLICKEN ZUM L√ñSCHEN!'; reset.classList.remove('danger-button'); reset.classList.add('confirm-button');
      reset.setAttribute('onclick','executeFullReset()'); cancel.style.display='block';
    };
    window.cancelReset = function(){
      const reset=document.getElementById('reset-button'), cancel=document.getElementById('cancel-reset-button');
      reset.textContent='ALLES ZUR√úCKSETZEN'; reset.classList.remove('confirm-button'); reset.classList.add('danger-button');
      reset.setAttribute('onclick','requestFullReset()'); cancel.style.display='none';
    };
    window.executeFullReset = async function(){
      if (!confirm("Wirklich ALLES zur√ºcksetzen?")) return;
      const snap = await getDocs(teamsCol);
      const deletions=[]; snap.forEach(d=>deletions.push(deleteDoc(d.ref)));
      await Promise.all(deletions);
      await setDoc(eventDoc, { currentStopIndex:-1, teamNames: window.TEAM_LIST }, { merge:true });
      await syncTeamsToList();
      alert("Zur√ºckgesetzt.");
      window.cancelReset?.();
    };

    // üîß Team-Namen speichern (mit Score-Migration)
    window.saveTeamNames = async function(){
      const inputs=[0,1,2,3].map(i=>document.getElementById(`team-name-${i}`));
      const proposed = inputs.map(i => (i.value||"").trim()).map(s=>s.replace(/\s+/g,' ').trim());

      // Validierung
      if (proposed.some(n => !n)){
        alert("Bitte alle vier Teamnamen ausf√ºllen.");
        return;
      }
      const unique = new Set(proposed.map(n=>n.toLowerCase()));
      if (unique.size !== proposed.length){
        alert("Teamnamen m√ºssen eindeutig sein.");
        return;
      }

      const oldList = window.TEAM_LIST.slice();
      const newList = proposed;

      // nichts ge√§ndert?
      if (oldList.join('|') === newList.join('|')){
        alert("Keine √Ñnderungen erkannt.");
        return;
      }

      // vorhandene Dokumente pr√ºfen
      const existingSnap = await getDocs(teamsCol);
      const existingIds = new Set(); existingSnap.forEach(d=>existingIds.add(d.id));

      // Konfliktcheck: Wenn newName bereits als Doc existiert, aber nicht aus einer 1:1-Umbenennung stammt
      for (const name of newList){
        if (existingIds.has(name) && !oldList.includes(name)){
          alert(`Der Name "${name}" existiert bereits als Team-Dokument. Bitte w√§hle einen anderen Namen oder benenne zuerst dieses Team um.`);
          return;
        }
      }

      // Migration nacheinander
      for (let i=0;i<oldList.length;i++){
        const oldName = oldList[i];
        const newName = newList[i];
        if (oldName === newName) continue;

        const oldRef = doc(db,"events",EVENT_ID,"teams",oldName);
        const newRef = doc(db,"events",EVENT_ID,"teams",newName);

        const oldSnap = await getDoc(oldRef);
        const oldData = oldSnap.exists() ? oldSnap.data() : { holes:holesArray(), penalty:0 };
        // Schreiben neues Doc (√ºberschreibt/merge)
        await setDoc(newRef, { name:newName, holes:Array.isArray(oldData.holes)?oldData.holes:holesArray(), penalty:Number.isFinite(oldData.penalty)?oldData.penalty:0 }, { merge:true });
        // Altes l√∂schen (erst nach Erfolg)
        if (oldSnap.exists()){
          await deleteDoc(oldRef);
        }
      }

      // neue Reihenfolge & Namen im EventDoc speichern
      await setDoc(eventDoc, { teamNames: newList }, { merge:true });
      window.TEAM_LIST = newList.slice();

      // sicherstellen, dass Scores-Struktur passt
      await syncTeamsToList();

      // UI aktualisieren
      if (typeof initAdminPanel === "function") initAdminPanel();
      if (typeof updateLeaderboardView === "function") updateLeaderboardView();

      alert("Teamnamen gespeichert!");
    };
  }
</script>
</body>
</html>
